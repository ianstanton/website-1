
<!doctype html>
<html lang="en" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
      
      
      
        <link rel="prev" href="../relations/">
      
      
        <link rel="next" href="../security/">
      
      <link rel="icon" href="../../favicon.png">
      <meta name="generator" content="mkdocs-1.4.2, mkdocs-material-9.0.1">
    
    
      
        <title>Testing - kube</title>
      
    
    
      <link rel="stylesheet" href="../../assets/stylesheets/main.3bd4f189.min.css">
      
        
        <link rel="stylesheet" href="../../assets/stylesheets/palette.2505c338.min.css">
      
      

    
    
    
      
        
        
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,300i,400,400i,700,700i%7CRoboto+Mono:400,400i,700,700i&display=fallback">
        <style>:root{--md-text-font:"Roboto";--md-code-font:"Roboto Mono"}</style>
      
    
    
    <script>__md_scope=new URL("../..",location),__md_hash=e=>[...e].reduce((e,_)=>(e<<5)-e+_.charCodeAt(0),0),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script>
    
      

    
    
    
  </head>
  
  
    
    
      
    
    
    
    
    <body dir="ltr" data-md-color-scheme="slate" data-md-color-primary="blue" data-md-color-accent="blue">
  
    
    
      <script>var palette=__md_get("__palette");if(palette&&"object"==typeof palette.color)for(var key of Object.keys(palette.color))document.body.setAttribute("data-md-color-"+key,palette.color[key])</script>
    
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" for="__drawer"></label>
    <div data-md-component="skip">
      
        
        <a href="#testing" class="md-skip">
          Skip to content
        </a>
      
    </div>
    <div data-md-component="announce">
      
    </div>
    
    
      

<header class="md-header" data-md-component="header">
  <nav class="md-header__inner md-grid" aria-label="Header">
    <a href="../.." title="kube" class="md-header__button md-logo" aria-label="kube" data-md-component="logo">
      
  <img src="../../favicon.png" alt="logo">

    </a>
    <label class="md-header__button md-icon" for="__drawer">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 6h18v2H3V6m0 5h18v2H3v-2m0 5h18v2H3v-2Z"/></svg>
    </label>
    <div class="md-header__title" data-md-component="header-title">
      <div class="md-header__ellipsis">
        <div class="md-header__topic">
          <span class="md-ellipsis">
            kube
          </span>
        </div>
        <div class="md-header__topic" data-md-component="header-topic">
          <span class="md-ellipsis">
            
              Testing
            
          </span>
        </div>
      </div>
    </div>
    
      <form class="md-header__option" data-md-component="palette">
        
          
          <input class="md-option" data-md-color-media="(prefers-color-scheme: dark)" data-md-color-scheme="slate" data-md-color-primary="blue" data-md-color-accent="blue"  aria-label="Switch to light mode"  type="radio" name="__palette" id="__palette_1">
          
            <label class="md-header__button md-icon" title="Switch to light mode" for="__palette_2" hidden>
              <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M17 7H7a5 5 0 0 0-5 5 5 5 0 0 0 5 5h10a5 5 0 0 0 5-5 5 5 0 0 0-5-5m0 8a3 3 0 0 1-3-3 3 3 0 0 1 3-3 3 3 0 0 1 3 3 3 3 0 0 1-3 3Z"/></svg>
            </label>
          
        
          
          <input class="md-option" data-md-color-media="(prefers-color-scheme: light)" data-md-color-scheme="default" data-md-color-primary="indigo" data-md-color-accent="light-blue"  aria-label="Switch to dark mode"  type="radio" name="__palette" id="__palette_2">
          
            <label class="md-header__button md-icon" title="Switch to dark mode" for="__palette_1" hidden>
              <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M17 6H7c-3.31 0-6 2.69-6 6s2.69 6 6 6h10c3.31 0 6-2.69 6-6s-2.69-6-6-6zm0 10H7c-2.21 0-4-1.79-4-4s1.79-4 4-4h10c2.21 0 4 1.79 4 4s-1.79 4-4 4zM7 9c-1.66 0-3 1.34-3 3s1.34 3 3 3 3-1.34 3-3-1.34-3-3-3z"/></svg>
            </label>
          
        
      </form>
    
    
    
      <label class="md-header__button md-icon" for="__search">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5Z"/></svg>
      </label>
      <div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" aria-label="Search" placeholder="Search" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="search-query" required>
      <label class="md-search__icon md-icon" for="__search">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5Z"/></svg>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12Z"/></svg>
      </label>
      <nav class="md-search__options" aria-label="Search">
        
        <button type="reset" class="md-search__icon md-icon" title="Clear" aria-label="Clear" tabindex="-1">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12 19 6.41Z"/></svg>
        </button>
      </nav>
      
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" data-md-scrollfix>
        <div class="md-search-result" data-md-component="search-result">
          <div class="md-search-result__meta">
            Initializing search
          </div>
          <ol class="md-search-result__list"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
    
    
      <div class="md-header__source">
        <a href="https://github.com/kube-rs/kube" title="Go to repository" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 496 512"><!--! Font Awesome Free 6.2.1 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2022 Fonticons, Inc.--><path d="M165.9 397.4c0 2-2.3 3.6-5.2 3.6-3.3.3-5.6-1.3-5.6-3.6 0-2 2.3-3.6 5.2-3.6 3-.3 5.6 1.3 5.6 3.6zm-31.1-4.5c-.7 2 1.3 4.3 4.3 4.9 2.6 1 5.6 0 6.2-2s-1.3-4.3-4.3-5.2c-2.6-.7-5.5.3-6.2 2.3zm44.2-1.7c-2.9.7-4.9 2.6-4.6 4.9.3 2 2.9 3.3 5.9 2.6 2.9-.7 4.9-2.6 4.6-4.6-.3-1.9-3-3.2-5.9-2.9zM244.8 8C106.1 8 0 113.3 0 252c0 110.9 69.8 205.8 169.5 239.2 12.8 2.3 17.3-5.6 17.3-12.1 0-6.2-.3-40.4-.3-61.4 0 0-70 15-84.7-29.8 0 0-11.4-29.1-27.8-36.6 0 0-22.9-15.7 1.6-15.4 0 0 24.9 2 38.6 25.8 21.9 38.6 58.6 27.5 72.9 20.9 2.3-16 8.8-27.1 16-33.7-55.9-6.2-112.3-14.3-112.3-110.5 0-27.5 7.6-41.3 23.6-58.9-2.6-6.5-11.1-33.3 2.6-67.9 20.9-6.5 69 27 69 27 20-5.6 41.5-8.5 62.8-8.5s42.8 2.9 62.8 8.5c0 0 48.1-33.6 69-27 13.7 34.7 5.2 61.4 2.6 67.9 16 17.7 25.8 31.5 25.8 58.9 0 96.5-58.9 104.2-114.8 110.5 9.2 7.9 17 22.9 17 46.4 0 33.7-.3 75.4-.3 83.6 0 6.5 4.6 14.4 17.3 12.1C428.2 457.8 496 362.9 496 252 496 113.3 383.5 8 244.8 8zM97.2 352.9c-1.3 1-1 3.3.7 5.2 1.6 1.6 3.9 2.3 5.2 1 1.3-1 1-3.3-.7-5.2-1.6-1.6-3.9-2.3-5.2-1zm-10.8-8.1c-.7 1.3.3 2.9 2.3 3.9 1.6 1 3.6.7 4.3-.7.7-1.3-.3-2.9-2.3-3.9-2-.6-3.6-.3-4.3.7zm32.4 35.6c-1.6 1.3-1 4.3 1.3 6.2 2.3 2.3 5.2 2.6 6.5 1 1.3-1.3.7-4.3-1.3-6.2-2.2-2.3-5.2-2.6-6.5-1zm-11.4-14.7c-1.6 1-1.6 3.6 0 5.9 1.6 2.3 4.3 3.3 5.6 2.3 1.6-1.3 1.6-3.9 0-6.2-1.4-2.3-4-3.3-5.6-2z"/></svg>
  </div>
  <div class="md-source__repository">
    kube
  </div>
</a>
      </div>
    
  </nav>
  
</header>
    
    <div class="md-container" data-md-component="container">
      
      
        
          
            
<nav class="md-tabs" aria-label="Tabs" data-md-component="tabs">
  <div class="md-tabs__inner md-grid">
    <ul class="md-tabs__list">
      
        
  
  


  
  
  
    <li class="md-tabs__item">
      <a href="../../getting-started/" class="md-tabs__link">
        Information
      </a>
    </li>
  

      
        
  
  
    
  


  
  
  
    <li class="md-tabs__item">
      <a href="../intro/" class="md-tabs__link md-tabs__link--active">
        Controllers
      </a>
    </li>
  

      
        
  
  


  
  
  
    <li class="md-tabs__item">
      <a href="../../crates/kube/" class="md-tabs__link">
        Crates
      </a>
    </li>
  

      
        
  
  


  
  
  
    <li class="md-tabs__item">
      <a href="../../governance/" class="md-tabs__link">
        Contributing
      </a>
    </li>
  

      
    </ul>
  </div>
</nav>
          
        
      
      <main class="md-main" data-md-component="main">
        <div class="md-main__inner md-grid">
          
            
              
              <div class="md-sidebar md-sidebar--primary" data-md-component="sidebar" data-md-type="navigation" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    

  


<nav class="md-nav md-nav--primary md-nav--lifted" aria-label="Navigation" data-md-level="0">
  <label class="md-nav__title" for="__drawer">
    <a href="../.." title="kube" class="md-nav__button md-logo" aria-label="kube" data-md-component="logo">
      
  <img src="../../favicon.png" alt="logo">

    </a>
    kube
  </label>
  
    <div class="md-nav__source">
      <a href="https://github.com/kube-rs/kube" title="Go to repository" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 496 512"><!--! Font Awesome Free 6.2.1 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2022 Fonticons, Inc.--><path d="M165.9 397.4c0 2-2.3 3.6-5.2 3.6-3.3.3-5.6-1.3-5.6-3.6 0-2 2.3-3.6 5.2-3.6 3-.3 5.6 1.3 5.6 3.6zm-31.1-4.5c-.7 2 1.3 4.3 4.3 4.9 2.6 1 5.6 0 6.2-2s-1.3-4.3-4.3-5.2c-2.6-.7-5.5.3-6.2 2.3zm44.2-1.7c-2.9.7-4.9 2.6-4.6 4.9.3 2 2.9 3.3 5.9 2.6 2.9-.7 4.9-2.6 4.6-4.6-.3-1.9-3-3.2-5.9-2.9zM244.8 8C106.1 8 0 113.3 0 252c0 110.9 69.8 205.8 169.5 239.2 12.8 2.3 17.3-5.6 17.3-12.1 0-6.2-.3-40.4-.3-61.4 0 0-70 15-84.7-29.8 0 0-11.4-29.1-27.8-36.6 0 0-22.9-15.7 1.6-15.4 0 0 24.9 2 38.6 25.8 21.9 38.6 58.6 27.5 72.9 20.9 2.3-16 8.8-27.1 16-33.7-55.9-6.2-112.3-14.3-112.3-110.5 0-27.5 7.6-41.3 23.6-58.9-2.6-6.5-11.1-33.3 2.6-67.9 20.9-6.5 69 27 69 27 20-5.6 41.5-8.5 62.8-8.5s42.8 2.9 62.8 8.5c0 0 48.1-33.6 69-27 13.7 34.7 5.2 61.4 2.6 67.9 16 17.7 25.8 31.5 25.8 58.9 0 96.5-58.9 104.2-114.8 110.5 9.2 7.9 17 22.9 17 46.4 0 33.7-.3 75.4-.3 83.6 0 6.5 4.6 14.4 17.3 12.1C428.2 457.8 496 362.9 496 252 496 113.3 383.5 8 244.8 8zM97.2 352.9c-1.3 1-1 3.3.7 5.2 1.6 1.6 3.9 2.3 5.2 1 1.3-1 1-3.3-.7-5.2-1.6-1.6-3.9-2.3-5.2-1zm-10.8-8.1c-.7 1.3.3 2.9 2.3 3.9 1.6 1 3.6.7 4.3-.7.7-1.3-.3-2.9-2.3-3.9-2-.6-3.6-.3-4.3.7zm32.4 35.6c-1.6 1.3-1 4.3 1.3 6.2 2.3 2.3 5.2 2.6 6.5 1 1.3-1.3.7-4.3-1.3-6.2-2.2-2.3-5.2-2.6-6.5-1zm-11.4-14.7c-1.6 1-1.6 3.6 0 5.9 1.6 2.3 4.3 3.3 5.6 2.3 1.6-1.3 1.6-3.9 0-6.2-1.4-2.3-4-3.3-5.6-2z"/></svg>
  </div>
  <div class="md-source__repository">
    kube
  </div>
</a>
    </div>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
      

  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_1" type="checkbox" id="__nav_1" >
      
      
      
      
        <label class="md-nav__link" for="__nav_1">
          Information
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" aria-label="Information" data-md-level="1">
        <label class="md-nav__title" for="__nav_1">
          <span class="md-nav__icon md-icon"></span>
          Information
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../getting-started/" class="md-nav__link">
        Getting started
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../changelog/" class="md-nav__link">
        Changelog
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../security/" class="md-nav__link">
        Security
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../release-process/" class="md-nav__link">
        Release Process
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../rust-version/" class="md-nav__link">
        Rust Version
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../kubernetes-version/" class="md-nav__link">
        Kubernetes version
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../architecture/" class="md-nav__link">
        Architecture
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../adopters/" class="md-nav__link">
        Adopters
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

    
      
      
      

  
  
    
  
  
    
    <li class="md-nav__item md-nav__item--active md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_2" type="checkbox" id="__nav_2" checked>
      
      
      
      
        <label class="md-nav__link" for="__nav_2">
          Controllers
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" aria-label="Controllers" data-md-level="1">
        <label class="md-nav__title" for="__nav_2">
          <span class="md-nav__icon md-icon"></span>
          Controllers
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../intro/" class="md-nav__link">
        Introduction
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../object/" class="md-nav__link">
        The Object
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../reconciler/" class="md-nav__link">
        The Reconciler
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../application/" class="md-nav__link">
        The Application
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../observability/" class="md-nav__link">
        Observability
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../relations/" class="md-nav__link">
        Related Objects
      </a>
    </li>
  

            
          
            
              
  
  
    
  
  
    <li class="md-nav__item md-nav__item--active">
      
      <input class="md-nav__toggle md-toggle" data-md-toggle="toc" type="checkbox" id="__toc">
      
      
        
      
      
        <label class="md-nav__link md-nav__link--active" for="__toc">
          Testing
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <a href="./" class="md-nav__link md-nav__link--active">
        Testing
      </a>
      
        

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#terminology" class="md-nav__link">
    Terminology
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#unit-tests" class="md-nav__link">
    Unit Tests
  </a>
  
    <nav class="md-nav" aria-label="Unit Tests">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#benefits" class="md-nav__link">
    Benefits
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#downsides" class="md-nav__link">
    Downsides
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#kubernetes-io-strategies" class="md-nav__link">
    Kubernetes IO Strategies
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#unit-tests-with-mocks" class="md-nav__link">
    Unit Tests with Mocks
  </a>
  
    <nav class="md-nav" aria-label="Unit Tests with Mocks">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#example" class="md-nav__link">
    Example
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#benefits_1" class="md-nav__link">
    Benefits
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#downsides_1" class="md-nav__link">
    Downsides
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#external-examples" class="md-nav__link">
    External Examples
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#integration-tests" class="md-nav__link">
    Integration Tests
  </a>
  
    <nav class="md-nav" aria-label="Integration Tests">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#example_1" class="md-nav__link">
    Example
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#benefits_2" class="md-nav__link">
    Benefits
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#downsides_2" class="md-nav__link">
    Downsides
  </a>
  
    <nav class="md-nav" aria-label="Downsides">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#low-reliability" class="md-nav__link">
    Low Reliability
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#no-isolation" class="md-nav__link">
    No Isolation
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#black-box-variant" class="md-nav__link">
    Black Box Variant
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#functional-variant" class="md-nav__link">
    Functional Variant
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#end-to-end-tests" class="md-nav__link">
    End to End Tests
  </a>
  
    <nav class="md-nav" aria-label="End to End Tests">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#example_2" class="md-nav__link">
    Example
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#benefits_3" class="md-nav__link">
    Benefits
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#downsides_3" class="md-nav__link">
    Downsides
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#summary" class="md-nav__link">
    Summary
  </a>
  
</li>
      
    </ul>
  
</nav>
      
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../security/" class="md-nav__link">
        Security
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

    
      
      
      

  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_3" type="checkbox" id="__nav_3" >
      
      
      
      
        <label class="md-nav__link" for="__nav_3">
          Crates
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" aria-label="Crates" data-md-level="1">
        <label class="md-nav__title" for="__nav_3">
          <span class="md-nav__icon md-icon"></span>
          Crates
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../crates/kube/" class="md-nav__link">
        kube
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../crates/kube-core/" class="md-nav__link">
        kube-core
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../crates/kube-client/" class="md-nav__link">
        kube-client
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../crates/kube-derive/" class="md-nav__link">
        kube-derive
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../crates/kube-runtime/" class="md-nav__link">
        kube-runtime
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

    
      
      
      

  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_4" type="checkbox" id="__nav_4" >
      
      
      
      
        <label class="md-nav__link" for="__nav_4">
          Contributing
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" aria-label="Contributing" data-md-level="1">
        <label class="md-nav__title" for="__nav_4">
          <span class="md-nav__icon md-icon"></span>
          Contributing
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../governance/" class="md-nav__link">
        Governance
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../maintainers/" class="md-nav__link">
        Maintainers
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../contributing/" class="md-nav__link">
        Contributing
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../website/" class="md-nav__link">
        Website
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../tools/" class="md-nav__link">
        Tools
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              
              <div class="md-sidebar md-sidebar--secondary" data-md-component="sidebar" data-md-type="toc" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#terminology" class="md-nav__link">
    Terminology
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#unit-tests" class="md-nav__link">
    Unit Tests
  </a>
  
    <nav class="md-nav" aria-label="Unit Tests">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#benefits" class="md-nav__link">
    Benefits
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#downsides" class="md-nav__link">
    Downsides
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#kubernetes-io-strategies" class="md-nav__link">
    Kubernetes IO Strategies
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#unit-tests-with-mocks" class="md-nav__link">
    Unit Tests with Mocks
  </a>
  
    <nav class="md-nav" aria-label="Unit Tests with Mocks">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#example" class="md-nav__link">
    Example
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#benefits_1" class="md-nav__link">
    Benefits
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#downsides_1" class="md-nav__link">
    Downsides
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#external-examples" class="md-nav__link">
    External Examples
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#integration-tests" class="md-nav__link">
    Integration Tests
  </a>
  
    <nav class="md-nav" aria-label="Integration Tests">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#example_1" class="md-nav__link">
    Example
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#benefits_2" class="md-nav__link">
    Benefits
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#downsides_2" class="md-nav__link">
    Downsides
  </a>
  
    <nav class="md-nav" aria-label="Downsides">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#low-reliability" class="md-nav__link">
    Low Reliability
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#no-isolation" class="md-nav__link">
    No Isolation
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#black-box-variant" class="md-nav__link">
    Black Box Variant
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#functional-variant" class="md-nav__link">
    Functional Variant
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#end-to-end-tests" class="md-nav__link">
    End to End Tests
  </a>
  
    <nav class="md-nav" aria-label="End to End Tests">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#example_2" class="md-nav__link">
    Example
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#benefits_3" class="md-nav__link">
    Benefits
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#downsides_3" class="md-nav__link">
    Downsides
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#summary" class="md-nav__link">
    Summary
  </a>
  
</li>
      
    </ul>
  
</nav>
                  </div>
                </div>
              </div>
            
          
          
            <div class="md-content" data-md-component="content">
              <article class="md-content__inner md-typeset">
                
                  



<h1 id="testing">Testing<a class="headerlink" href="#testing" title="Permanent link">#</a></h1>
<p>This chapter covers <strong>controller testing</strong> and example Rust Kubernetes test patterns.</p>
<h2 id="terminology">Terminology<a class="headerlink" href="#terminology" title="Permanent link">#</a></h2>
<p>We will loosely re-use the <a href="https://github.com/kube-rs/kube/blob/main/CONTRIBUTING.md#testing">kube test categories</a> and outline four types of tests:</p>
<ul>
<li><strong>End to End tests</strong> (requires Kubernetes through an <strong>in-cluster</strong> Client)</li>
<li><strong>Integration tests</strong> (requires Kubernetes)</li>
<li><strong>Mocked unit tests</strong> (requires mocking Kubernetes dependencies)</li>
<li><strong>Unit tests</strong> (no Kubernetes calls)</li>
</ul>
<p>These types should roughly match what you see in a standard <strong>test pyramid</strong> where testing power and maintenance costs both increase as you go up the list.</p>
<div class="admonition note">
<p class="admonition-title">Classification Subjectivity</p>
<p>This classification and terminology re-use herein is partially subjective. Variant approaches are discussed.</p>
</div>
<h2 id="unit-tests">Unit Tests<a class="headerlink" href="#unit-tests" title="Permanent link">#</a></h2>
<p>The basic unit <code>#[test]</code>. Typically composed of individual test function in a <strong>tests only</strong> module inlined in files containing what you want to test.</p>
<p>We will defer to various official guides on good unit test writing in rust:</p>
<ul>
<li><a href="https://doc.rust-lang.org/rust-by-example/testing/unit_testing.html">rust by example - unit tests</a></li>
<li><a href="https://doc.rust-lang.org/book/ch11-01-writing-tests.html">rust book - writing tests</a></li>
</ul>
<h3 id="benefits">Benefits<a class="headerlink" href="#benefits" title="Permanent link">#</a></h3>
<p>Very simple to setup, with generally no extra interfaces needed.</p>
<p>Works extremely well for algorithms, state machinery, and business logic that has been separated out from network behavior (e.g. the <a href="https://sans-io.readthedocs.io/">sans-IO</a> approach). Splitting out business logic from IO will reduce the need for more expensive tests below and should be favored where possible.</p>
<h3 id="downsides">Downsides<a class="headerlink" href="#downsides" title="Permanent link">#</a></h3>
<p>While it is definitely possible to <a href="https://verraes.net/2014/12/how-much-testing-is-too-much/">go overboard with unit tests</a> and test too deeply (without protecting any real invariants), this is not what we will focus on here. When unit tests are appropriate, they are great.</p>
<p>In the controller context, the <strong>main unit test downside</strong> is that we <strong>cannot cover the IO component</strong> without something standing in for Kubernetes - such as an apiserver mock or an actual cluster - making it, by definition, not a plain unit test anymore. </p>
<p>The controller is fundamentally tied up in the <a href="../reconciler/">reconciler</a>, so there is always going to be a sizable chunk of code that you <strong>cannot do with plain unit tests</strong>.</p>
<h2 id="kubernetes-io-strategies">Kubernetes IO Strategies<a class="headerlink" href="#kubernetes-io-strategies" title="Permanent link">#</a></h2>
<p>For the <a href="../reconciler/">reconciler</a> (and similar Kubernetes calling logic you may have), there are <strong>3 major strategies to test</strong> this code.</p>
<p>You have one basic choice:</p>
<ol>
<li>stay in unit-test land by mocking out your network dependencies (worse test code)</li>
<li>move up the test pyramid and do full-scale integration testing (worse test reliability)</li>
</ol>
<p>and then you can also choose to do e2e testing either as an additional bonus, or as a substitute for integration testing. Larger projects <strong>may wish to do everything</strong>.</p>
<div class="admonition note">
<p class="admonition-title">Idempotency reducing the need for tests</p>
<p>The more you learn to lean on using <a href="https://kubernetes.io/docs/reference/using-api/server-side-apply/">Server-Side Apply</a>, the less if/else gates will end up with in your reconciler, and thus the less testing you will need.</p>
</div>
<h2 id="unit-tests-with-mocks">Unit Tests with Mocks<a class="headerlink" href="#unit-tests-with-mocks" title="Permanent link">#</a></h2>
<p>It is possible to to test your reconciler and IO logic and retain the speed and isolation of unit tests by using mocks. This is common practice to avoid having to bring in your all your dependencies and is typically done through crates such as <a href="https://crates.io/crates/wiremock">wiremock</a>, <a href="https://crates.io/crates/mockito">mockito</a>, <a href="https://crates.io/crates/tower-test">tower-test</a>, or <a href="https://crates.io/crates/mockall">mockall</a>.</p>
<p>Out of these, <a href="https://crates.io/crates/tower-test">tower-test</a> integrates well with our <a href="https://docs.rs/kube/latest/kube/struct.Client.html">Client</a> out of the box, and is the one we will focus on here.</p>
<!-- TODO: links to other use cases with wiremock? -->

<h3 id="example">Example<a class="headerlink" href="#example" title="Permanent link">#</a></h3>
<p>To create a mocked <a href="https://docs.rs/kube/latest/kube/struct.Client.html">Client</a> with <code>tower-test</code> it is sufficient to instantiate one on a mock service:</p>
<div class="highlight"><pre><span></span><code><span class="kd">let</span><span class="w"> </span><span class="p">(</span><span class="n">mocksvc</span><span class="p">,</span><span class="w"> </span><span class="n">handle</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">tower_test</span>::<span class="n">mock</span>::<span class="n">pair</span>::<span class="o">&lt;</span><span class="n">Request</span><span class="o">&lt;</span><span class="n">Body</span><span class="o">&gt;</span><span class="p">,</span><span class="w"> </span><span class="n">Response</span><span class="o">&lt;</span><span class="n">Body</span><span class="o">&gt;&gt;</span><span class="p">();</span>
<span class="kd">let</span><span class="w"> </span><span class="n">client</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Client</span>::<span class="n">new</span><span class="p">(</span><span class="n">mocksvc</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;default&quot;</span><span class="p">);</span>
</code></pre></div>
<p>This is using the generic:</p>
<ul>
<li><a href="https://docs.rs/http/latest/http/request/struct.Request.html"><code>http::Request</code></a> + <a href="https://docs.rs/http/latest/http/response/struct.Response.html"><code>http::Response</code></a> objects</li>
<li><a href="https://docs.rs/hyper/latest/hyper/struct.Body.html"><code>hyper::Body</code></a> as request/response content</li>
</ul>
<p>This <code>Client</code> can then be passed into to reconciler in the usual way through a context object (<a href="../reconciler/#using-context">reconciler##using-context</a>), allowing you to test <code>reconcile</code> directly.</p>
<p>You do need to write a bit of code to make the test <code>handle</code> do the right thing though, and this does require a bit of boilerplate because there is nothing equivalent to <a href="https://book.kubebuilder.io/reference/envtest.html"><code>envtest</code></a> in Rust (<a href="https://github.com/kube-rs/kube/issues/1108">so far</a>). Effectively, we need to mock bits of the <a href="https://kubernetes.io/docs/reference/command-line-tools-reference/kube-apiserver/">kube-apiserver</a> and it can look something like this:</p>
<div class="highlight"><pre><span></span><code><span class="c1">// We wrap tower_test::mock::Handle</span>
<span class="k">type</span> <span class="nc">ApiServerHandle</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">tower_test</span>::<span class="n">mock</span>::<span class="n">Handle</span><span class="o">&lt;</span><span class="n">Request</span><span class="o">&lt;</span><span class="n">Body</span><span class="o">&gt;</span><span class="p">,</span><span class="w"> </span><span class="n">Response</span><span class="o">&lt;</span><span class="n">Body</span><span class="o">&gt;&gt;</span><span class="p">;</span>
<span class="k">pub</span><span class="w"> </span><span class="k">struct</span> <span class="nc">ApiServerVerifier</span><span class="p">(</span><span class="n">ApiServerHandle</span><span class="p">);</span>

<span class="sd">/// Scenarios we want to test for</span>
<span class="k">pub</span><span class="w"> </span><span class="k">enum</span> <span class="nc">Scenario</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="sd">/// We expect exactly one `patch_status` call to the `Document` resource</span>
<span class="w">    </span><span class="n">StatusPatch</span><span class="p">(</span><span class="n">Document</span><span class="p">),</span>
<span class="w">    </span><span class="sd">/// We expect nothing to be sent to Kubernetes</span>
<span class="w">    </span><span class="n">RadioSilence</span><span class="p">,</span>
<span class="p">}</span>
<span class="k">impl</span><span class="w"> </span><span class="n">ApiServerVerifier</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">pub</span><span class="w"> </span><span class="k">fn</span> <span class="nf">run</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="w"> </span><span class="n">scenario</span>: <span class="nc">Scenario</span><span class="p">)</span><span class="w"> </span>-&gt; <span class="nc">tokio</span>::<span class="n">task</span>::<span class="n">JoinHandle</span><span class="o">&lt;</span><span class="p">()</span><span class="o">&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="n">tokio</span>::<span class="n">spawn</span><span class="p">(</span><span class="k">async</span><span class="w"> </span><span class="k">move</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="c1">// moving self =&gt; one scenario per test</span>
<span class="w">            </span><span class="k">match</span><span class="w"> </span><span class="n">scenario</span><span class="w"> </span><span class="p">{</span>
<span class="w">                </span><span class="n">Scenario</span>::<span class="n">StatusPatch</span><span class="p">(</span><span class="n">doc</span><span class="p">)</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="bp">self</span><span class="p">.</span><span class="n">handle_status_patch</span><span class="p">(</span><span class="n">doc</span><span class="p">).</span><span class="k">await</span><span class="p">,</span>
<span class="w">                </span><span class="n">Scenario</span>::<span class="n">RadioSilence</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="nb">Ok</span><span class="p">(</span><span class="bp">self</span><span class="p">),</span>
<span class="w">            </span><span class="p">}</span>
<span class="w">            </span><span class="p">.</span><span class="n">expect</span><span class="p">(</span><span class="s">&quot;scenario completed without errors&quot;</span><span class="p">);</span>
<span class="w">        </span><span class="p">})</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="sd">/// Respond to PATCH /status with passed doc + status from request body</span>
<span class="w">    </span><span class="k">async</span><span class="w"> </span><span class="k">fn</span> <span class="nf">handle_status_patch</span><span class="p">(</span><span class="k">mut</span><span class="w"> </span><span class="bp">self</span><span class="p">,</span><span class="w"> </span><span class="n">doc</span>: <span class="nc">Document</span><span class="p">)</span><span class="w"> </span>-&gt; <span class="nb">Result</span><span class="o">&lt;</span><span class="bp">Self</span><span class="o">&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="kd">let</span><span class="w"> </span><span class="p">(</span><span class="n">request</span><span class="p">,</span><span class="w"> </span><span class="n">send</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="bp">self</span><span class="p">.</span><span class="mf">0.</span><span class="n">next_request</span><span class="p">().</span><span class="k">await</span><span class="p">.</span><span class="n">expect</span><span class="p">(</span><span class="s">&quot;service not called&quot;</span><span class="p">);</span>
<span class="w">        </span><span class="fm">assert_eq!</span><span class="p">(</span><span class="n">request</span><span class="p">.</span><span class="n">method</span><span class="p">(),</span><span class="w"> </span><span class="n">http</span>::<span class="n">Method</span>::<span class="n">PATCH</span><span class="p">);</span>
<span class="w">        </span><span class="kd">let</span><span class="w"> </span><span class="n">exp_url</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="fm">format!</span><span class="p">(</span><span class="s">&quot;/apis/kube.rs/v1/namespaces/testns/documents/{}/status?&amp;force=true&amp;fieldManager=cntrlr&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">doc</span><span class="p">.</span><span class="n">name_any</span><span class="p">());</span>
<span class="w">        </span><span class="fm">assert_eq!</span><span class="p">(</span><span class="n">request</span><span class="p">.</span><span class="n">uri</span><span class="p">().</span><span class="n">to_string</span><span class="p">(),</span><span class="w"> </span><span class="n">exp_url</span><span class="p">);</span>
<span class="w">        </span><span class="c1">// extract the `status` object from the `patch_status` call via the body of the request</span>
<span class="w">        </span><span class="kd">let</span><span class="w"> </span><span class="n">req_body</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">to_bytes</span><span class="p">(</span><span class="n">request</span><span class="p">.</span><span class="n">into_body</span><span class="p">()).</span><span class="k">await</span><span class="p">.</span><span class="n">unwrap</span><span class="p">();</span>
<span class="w">        </span><span class="kd">let</span><span class="w"> </span><span class="n">json</span>: <span class="nc">serde_json</span>::<span class="n">Value</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">serde_json</span>::<span class="n">from_slice</span><span class="p">(</span><span class="o">&amp;</span><span class="n">req_body</span><span class="p">).</span><span class="n">expect</span><span class="p">(</span><span class="s">&quot;patch_status object is json&quot;</span><span class="p">);</span>
<span class="w">        </span><span class="kd">let</span><span class="w"> </span><span class="n">status_json</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">json</span><span class="p">.</span><span class="n">get</span><span class="p">(</span><span class="s">&quot;status&quot;</span><span class="p">).</span><span class="n">expect</span><span class="p">(</span><span class="s">&quot;status object&quot;</span><span class="p">).</span><span class="n">clone</span><span class="p">();</span>
<span class="w">        </span><span class="kd">let</span><span class="w"> </span><span class="n">status</span>: <span class="nc">DocumentStatus</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">serde_json</span>::<span class="n">from_value</span><span class="p">(</span><span class="n">status_json</span><span class="p">).</span><span class="n">expect</span><span class="p">(</span><span class="s">&quot;contains valid status&quot;</span><span class="p">);</span>
<span class="w">        </span><span class="c1">// attach it to the supplied document to pretend we are an apiserver</span>
<span class="w">        </span><span class="kd">let</span><span class="w"> </span><span class="n">response</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">serde_json</span>::<span class="n">to_vec</span><span class="p">(</span><span class="o">&amp;</span><span class="n">doc</span><span class="p">.</span><span class="n">with_status</span><span class="p">(</span><span class="n">status</span><span class="p">)).</span><span class="n">unwrap</span><span class="p">();</span>
<span class="w">        </span><span class="n">send</span><span class="p">.</span><span class="n">send_response</span><span class="p">(</span><span class="n">Response</span>::<span class="n">builder</span><span class="p">().</span><span class="n">body</span><span class="p">(</span><span class="n">Body</span>::<span class="n">from</span><span class="p">(</span><span class="n">response</span><span class="p">)).</span><span class="n">unwrap</span><span class="p">());</span>
<span class="w">        </span><span class="nb">Ok</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">}</span>
</code></pre></div>
<p>Here we have made an apiserver mock wrapper that will run certain scenarios. Each scenario calls a number of handler functions that assert on certain basic expectations about the nature of the message we receive. Here we only have made one for <code>handle_status_patch</code>, but more are used in <a href="https://github.com/kube-rs/controller-rs/blob/main/src/fixtures.rs">controller-rs/fixtures.rs</a>.</p>
<p>An <strong>actual tests</strong> that uses the above wrapper can end up being quite readable:</p>
<div class="highlight"><pre><span></span><code><span class="cp">#[tokio::test]</span>
<span class="k">async</span><span class="w"> </span><span class="k">fn</span> <span class="nf">doc_reconcile_causes_status_patch</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="p">(</span><span class="n">testctx</span><span class="p">,</span><span class="w"> </span><span class="n">fakeserver</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Context</span>::<span class="n">test</span><span class="p">();</span>
<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">doc</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Document</span>::<span class="n">test</span><span class="p">();</span>
<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">mocksrv</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">fakeserver</span><span class="p">.</span><span class="n">run</span><span class="p">(</span><span class="n">Scenario</span>::<span class="n">StatusPatch</span><span class="p">(</span><span class="n">doc</span><span class="p">.</span><span class="n">clone</span><span class="p">()));</span>
<span class="w">    </span><span class="n">reconcile</span><span class="p">(</span><span class="n">Arc</span>::<span class="n">new</span><span class="p">(</span><span class="n">doc</span><span class="p">),</span><span class="w"> </span><span class="n">testctx</span><span class="p">).</span><span class="k">await</span><span class="p">.</span><span class="n">expect</span><span class="p">(</span><span class="s">&quot;reconciler&quot;</span><span class="p">);</span>
<span class="w">    </span><span class="n">timeout_after_1s</span><span class="p">(</span><span class="n">mocksrv</span><span class="p">).</span><span class="k">await</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div>
<p>Effectively, this is an exercise in running two futures together (one in a task), and one in the main test fn, then joining at the end.</p>
<p>In this test we are effectively <strong>verifying</strong> that:</p>
<ol>
<li>reconcile ran successfully in the given scenario</li>
<li>apiserver handler saw all expected messages</li>
<li>apiserver handler saw no unexpected messages.</li>
</ol>
<p>This is <strong>satisfied because</strong>:</p>
<ol>
<li>reconcile is unwrapped while handler is running through the scenario</li>
<li>Each scenario blocked on sequential api calls to happen (we await each message), so mockserver's joinhandle will not resolve until <strong>every</strong> expected message in the given scenario has happened (hence the timeout) </li>
<li>If the mock server is receiving more Kubernetes calls than expected the reconciler will error with a <code>KubeError(Service(Closed(())))</code> caught by the reconcilers <code>expect</code></li>
</ol>
<div class="admonition note">
<p class="admonition-title">Context and Document constructors omitted</p>
<p>Test functions to create the rest of the reconciler context and a test document used by a reconciler are not shown, see <a href="https://github.com/kube-rs/controller-rs/blob/main/src/fixtures.rs">controller-rs/fixtures.rs</a> for a relatively small <code>Context</code>. Note that the more things you pass in to your reconciler the larger your <code>Context</code> will be, and the more stuff you will want to mock. </p>
</div>
<h3 id="benefits_1">Benefits<a class="headerlink" href="#benefits_1" title="Permanent link">#</a></h3>
<p>Using mocks are <strong>comparable</strong> to using integration tests in <strong>power and versatility</strong>. It lets us move up the pyramid in terms of testing power, but without needing an actual network boundary and a real cluster. As a result, we <strong>maintain test reliability</strong>.</p>
<h3 id="downsides_1">Downsides<a class="headerlink" href="#downsides_1" title="Permanent link">#</a></h3>
<p>Compared to using a real cluster, the amount of code we need to write - to compensate for a missing apiserver - is currently quite significant. This <strong>verbosity</strong> means a <em>higher initial cost</em> of writing these tests, and also <strong>more complexity</strong> to keep in your head and maintain. We hope that some of this complexity can be reduced in the future with more <a href="https://github.com/kube-rs/kube/issues/1108">Kubernetes focused test helpers</a>.</p>
<h3 id="external-examples">External Examples<a class="headerlink" href="#external-examples" title="Permanent link">#</a></h3>
<ul>
<li><a href="https://github.com/nais/hahaha/blob/43cff519ffbc7c0106ff46f963c3308329301500/src/reconciler.rs#L205-L308">nais/hahaha exec tests</a> using <a href="https://github.com/nais/hahaha/blob/43cff519ffbc7c0106ff46f963c3308329301500/src/api.rs#L13-L21">an automock trait</a></li>
</ul>
<h2 id="integration-tests">Integration Tests<a class="headerlink" href="#integration-tests" title="Permanent link">#</a></h2>
<p>Integration tests run against a <strong>real Kubernetes cluster</strong>, and lets you verify that the IO components of your controller is doing the right thing in a real environment. The big selling point is that they require little code to write and are easy to understand.</p>
<h3 id="example_1">Example<a class="headerlink" href="#example_1" title="Permanent link">#</a></h3>
<p>Let us try to verify the same status patching scenario from above using an integration test.</p>
<p>First, we need a working <a href="https://docs.rs/kube/latest/kube/struct.Client.html">Client</a>. Using <code>Client::try_default()</code> inside an async-aware <code>#[test]</code> we end up using using the <code>current-context</code> set in your local <a href="https://kubernetes.io/docs/concepts/configuration/organize-cluster-access-kubeconfig/">kubeconfig</a>.</p>
<div class="highlight"><pre><span></span><code><span class="w">    </span><span class="c1">// Integration test without mocks</span>
<span class="w">    </span><span class="k">use</span><span class="w"> </span><span class="n">kube</span>::<span class="n">api</span>::<span class="p">{</span><span class="n">Api</span><span class="p">,</span><span class="w"> </span><span class="n">Client</span><span class="p">,</span><span class="w"> </span><span class="n">ListParams</span><span class="p">,</span><span class="w"> </span><span class="n">Patch</span><span class="p">,</span><span class="w"> </span><span class="n">PatchParams</span><span class="p">};</span>
<span class="w">    </span><span class="cp">#[tokio::test]</span>
<span class="w">    </span><span class="cp">#[ignore = </span><span class="s">&quot;uses k8s current-context&quot;</span><span class="cp">]</span>
<span class="w">    </span><span class="k">async</span><span class="w"> </span><span class="k">fn</span> <span class="nf">integration_reconcile_should_set_status</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="kd">let</span><span class="w"> </span><span class="n">client</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Client</span>::<span class="n">try_default</span><span class="p">().</span><span class="k">await</span><span class="p">.</span><span class="n">unwrap</span><span class="p">();</span>
<span class="w">        </span><span class="kd">let</span><span class="w"> </span><span class="n">ctx</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">State</span>::<span class="n">default</span><span class="p">().</span><span class="n">to_context</span><span class="p">(</span><span class="n">client</span><span class="p">.</span><span class="n">clone</span><span class="p">());</span>

<span class="w">        </span><span class="c1">// create a test doc and run it through ~= kubectl apply --server-side</span>
<span class="w">        </span><span class="kd">let</span><span class="w"> </span><span class="n">doc</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Document</span>::<span class="n">test</span><span class="p">().</span><span class="n">finalized</span><span class="p">().</span><span class="n">needs_hide</span><span class="p">();</span>
<span class="w">        </span><span class="kd">let</span><span class="w"> </span><span class="n">docs</span>: <span class="nc">Api</span><span class="o">&lt;</span><span class="n">Document</span><span class="o">&gt;</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Api</span>::<span class="n">namespaced</span><span class="p">(</span><span class="n">client</span><span class="p">.</span><span class="n">clone</span><span class="p">(),</span><span class="w"> </span><span class="s">&quot;default&quot;</span><span class="p">);</span>
<span class="w">        </span><span class="kd">let</span><span class="w"> </span><span class="n">ssapply</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">PatchParams</span>::<span class="n">apply</span><span class="p">(</span><span class="s">&quot;ctrltest&quot;</span><span class="p">);</span>
<span class="w">        </span><span class="kd">let</span><span class="w"> </span><span class="n">patch</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Patch</span>::<span class="n">Apply</span><span class="p">(</span><span class="n">doc</span><span class="p">.</span><span class="n">clone</span><span class="p">());</span>
<span class="w">        </span><span class="n">docs</span><span class="p">.</span><span class="n">patch</span><span class="p">(</span><span class="s">&quot;test&quot;</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">ssapply</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">patch</span><span class="p">).</span><span class="k">await</span><span class="p">.</span><span class="n">unwrap</span><span class="p">();</span>

<span class="w">        </span><span class="c1">// reconcile it (as if it was just applied to the cluster like this)</span>
<span class="w">        </span><span class="n">reconcile</span><span class="p">(</span><span class="n">Arc</span>::<span class="n">new</span><span class="p">(</span><span class="n">doc</span><span class="p">),</span><span class="w"> </span><span class="n">ctx</span><span class="p">).</span><span class="k">await</span><span class="p">.</span><span class="n">unwrap</span><span class="p">();</span>

<span class="w">        </span><span class="c1">// verify side-effects happened</span>
<span class="w">        </span><span class="kd">let</span><span class="w"> </span><span class="n">output</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">docs</span><span class="p">.</span><span class="n">get_status</span><span class="p">(</span><span class="s">&quot;test&quot;</span><span class="p">).</span><span class="k">await</span><span class="p">.</span><span class="n">unwrap</span><span class="p">();</span>
<span class="w">        </span><span class="fm">assert!</span><span class="p">(</span><span class="n">output</span><span class="p">.</span><span class="n">status</span><span class="p">.</span><span class="n">is_some</span><span class="p">());</span>
<span class="w">    </span><span class="p">}</span>
</code></pre></div>
<p>this sets up a <code>Client</code>, a <code>Context</code> (to be passed to the reconciler), then applies an actual document into the cluster, and at the same time giving it to the reconciler.</p>
<p>Feeding the apply result (usually seen by watching the api) is what the <a href="https://docs.rs/kube/latest/kube/runtime/struct.Controller.html">Controller</a> internals does, so we skip testing this part. As a result, we get a much simpler test call around only <code>reconcile</code> that we can verify by querying the api after it has completed.</p>
<div class="admonition note">
<p>The tests at the bottom of <a href="https://github.com/kube-rs/controller-rs/blob/f084c15985b5de1b2cfee627613cd2b69c9530cd/src/controller.rs#L281-L315">controller-rs/controller.rs</a> go a little deeper, testing a larger scenario.</p>
</div>
<p>We <strong>need</strong> a cluster for these tests though, so on CI we will spin up a <a href="https://k3d.io/">k3d</a> instance for each PR. Here is a GitHub Actions based setup:</p>
<div class="highlight"><pre><span></span><code><span class="w">  </span><span class="nt">integration</span><span class="p">:</span>
<span class="w">    </span><span class="nt">runs-on</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">ubuntu-latest</span>
<span class="w">    </span><span class="nt">strategy</span><span class="p">:</span>
<span class="w">      </span><span class="c1"># Prevent GitHub from cancelling all in-progress jobs when a matrix job fails.</span>
<span class="w">      </span><span class="nt">fail-fast</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">false</span>
<span class="w">      </span><span class="nt">matrix</span><span class="p">:</span>
<span class="w">        </span><span class="c1"># Run these tests against older clusters as well</span>
<span class="w">        </span><span class="nt">k8s</span><span class="p">:</span><span class="w"> </span><span class="p p-Indicator">[</span><span class="nv">v1.22</span><span class="p p-Indicator">,</span><span class="w"> </span><span class="nv">latest</span><span class="p p-Indicator">]</span>
<span class="w">    </span><span class="nt">steps</span><span class="p">:</span>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">uses</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">actions/checkout@v2</span>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">uses</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">actions-rs/toolchain@v1</span>
<span class="w">        </span><span class="nt">with</span><span class="p">:</span>
<span class="w">          </span><span class="nt">override</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">true</span>
<span class="w">          </span><span class="nt">toolchain</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">stable</span>
<span class="w">          </span><span class="nt">profile</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">minimal</span>
<span class="w">      </span><span class="c1"># Smart caching for Rust</span>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">uses</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Swatinem/rust-cache@v2</span>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">uses</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">nolar/setup-k3d-k3s@v1</span>
<span class="w">        </span><span class="nt">with</span><span class="p">:</span>
<span class="w">          </span><span class="nt">version</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">${{matrix.k8s}}</span>
<span class="w">          </span><span class="nt">k3d-name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">kube</span>
<span class="w">          </span><span class="c1"># Used to avoid rate limits when fetching the releases from k3s repo.</span>
<span class="w">          </span><span class="c1"># Anonymous access is limited to 60 requests / hour / worker</span>
<span class="w">          </span><span class="c1"># github-token: ${{ secrets.GITHUB_TOKEN }}</span>
<span class="w">          </span><span class="nt">k3d-args</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;--no-lb</span><span class="nv"> </span><span class="s">--no-rollback</span><span class="nv"> </span><span class="s">--k3s-arg</span><span class="nv"> </span><span class="s">--disable=traefik,servicelb,metrics-server@server:*&quot;</span>

<span class="w">      </span><span class="c1"># Real CI work starts here</span>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Build workspace</span>
<span class="w">        </span><span class="nt">run</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">cargo build</span>

<span class="w">      </span><span class="c1"># Run the integration tests</span>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">install crd</span>
<span class="w">        </span><span class="nt">run</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">cargo run --bin crdgen | kubectl apply -f -</span>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Run all default features integration library tests</span>
<span class="w">        </span><span class="nt">run</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">cargo test --lib --all -- --ignored</span>
</code></pre></div>
<p>This creates a minimal k3d cluster (against <strong>both</strong> the latest k3d version and <strong>our</strong> last supported k8s version), and then runs <code>cargo test -- --ignored</code> to specifically <strong>only</strong> run the <code>#[ignore]</code> marked integration tests.</p>
<div class="admonition note">
<p class="admonition-title"><code>#[ignore]</code> annotations on integration tests</p>
<p>We advocate for using the <code>#[ignore]</code> attribute as a visible opt-in for developers. The <code>Client::try_default</code> will work against whatever arbitrary cluster a developer has set to their <code>current-context</code>, so makes it harder (than merely typing <code>cargo test</code>) to accidentally modify random clusters.</p>
</div>
<h3 id="benefits_2">Benefits<a class="headerlink" href="#benefits_2" title="Permanent link">#</a></h3>
<p>As you can see, this is a lot simpler than the mocking version on the Rust side; no request/response handling and task spawning.</p>
<p>At the same time, these tests are more powerful than mocks; we can test the major flow path of a controller in a cluster against different Kubernetes versions with very little code.</p>
<h3 id="downsides_2">Downsides<a class="headerlink" href="#downsides_2" title="Permanent link">#</a></h3>
<h4 id="low-reliability">Low Reliability<a class="headerlink" href="#low-reliability" title="Permanent link">#</a></h4>
<p>While this will vary between CI providers, cluster setup problems are common.</p>
<p>As you now depend on both cluster specific actions to set up a cluster (e.g. <a href="https://github.com/nolar/setup-k3d-k3s">setup-k3d-k3s</a>), and the underlying cluster interface (e.g. <a href="https://k3d.io/">k3d</a>), you have to deal with compatibility issues between these. Spurious cluster creation failures on <abbr title="GitHub Actions">GHA</abbr> are common (particularly on <code>latest</code>).</p>
<p>You also have to wait for resources to be ready. Usually, this involves waiting for a <a href="https://docs.rs/kube/latest/kube/runtime/wait/trait.Condition.html">Condition</a>, but Kubernetes does not have conditions for everything<a href="https://docs.rs/kube/latest/kube/runtime/wait/conditions/fn.is_crd_established.html">*</a>, so you can still run into race conditions.</p>
<p>It is <strong>possible to reduce the reliability problems</strong> a bit by using <strong>dedicated clusters</strong>, but that brings us onto the second pain point;</p>
<h4 id="no-isolation">No Isolation<a class="headerlink" href="#no-isolation" title="Permanent link">#</a></h4>
<p>Tests from one file can cause <strong>interactions and race conditions</strong> with other tests, and re-using a cluster across test runs makes this problem worse as tests now need to be idempotent.</p>
<p>It is <strong>possible</strong> to achieve full test isolation for integration tests, but it often brings impractical costs (such as setting up a new cluster per test, or writing all tests to be idempotent and using disjoint resources).</p>
<p>Thus, you can only (realistically) write so many of these tests because you have to keep in your head which tests is doing what to your environment and they may be competing for the same resource names.</p>
<h3 id="black-box-variant">Black Box Variant<a class="headerlink" href="#black-box-variant" title="Permanent link">#</a></h3>
<p>The setup above is not a <a href="https://en.wikipedia.org/wiki/Black-box_testing">black-box integration test</a>, because we pull out internals to create state, and call <code>reconcile</code> almost like a unit test.</p>
<div class="admonition note">
<p class="admonition-title">Rust conventions on integration tests</p>
<p><a href="https://doc.rust-lang.org/book/ch11-03-test-organization.html">Rust defines integration tests</a> as acting only on public interfaces and residing in a separate <code>tests</code> directory. </p>
</div>
<p>We effectively have a <a href="https://en.wikipedia.org/wiki/White-box_testing">white-box integration test</a> instead.</p>
<p>It is <strong>possible to export</strong> our <code>reconcile</code> plus associated <code>Context</code> types as a new public interface from a new controller library, and then black-box test that (per the Rust definition) from a separate <code>tests</code> directory.</p>
<p>In the most basic cases, this is effectively a <strong>definitional hack</strong> as we;</p>
<ul>
<li>introduce an arbitrary public boundary that's only used by tests and controller main</li>
<li>declare this boundary as public, and test that (in the exact same way)</li>
<li>re-plumb controller main to use this interface rather than the old private internals</li>
</ul>
<p>But this does also <strong>separate the code</strong> that we consider <strong>important enough to test</strong> from the rest, and that boundary has been <strong>made explicit</strong> via the (technically unnecessary) library (at the cost of having more files and boundaries).</p>
<p>Doing so will make make your interfaces more explicit, and this can be valuable for more advanced controllers using multiple reconcilers.</p>
<!-- PRs welcome for examples -->

<h3 id="functional-variant">Functional Variant<a class="headerlink" href="#functional-variant" title="Permanent link">#</a></h3>
<p>Rather than moving interfaces around to fit definitions of black-box tests, we can can also <strong>remove all our assumptions about code layout</strong> in the first place, and create more <a href="https://en.wikipedia.org/wiki/Functional_testing">functional tests</a>.</p>
<p>In functional tests, we instead <strong>run the controller directly</strong>, and test against it, via something like:</p>
<ol>
<li>explicitly <code>cargo run &amp;</code> the controller binary</li>
<li><code>kubectl apply</code> a test document</li>
<li>verify your conditions outside (e.g. <code>kubectl wait</code> or a separate test suite)</li>
</ol>
<p><a href="https://github.com/CoreDB-io/coredb/tree/main/coredb-operator/tests">CoreDB's operator follows this approach</a>, and it is definitely an important thing to test. In this guide, you can see functional testing done as part of <strong>End to End Tests</strong>.</p>
<h2 id="end-to-end-tests">End to End Tests<a class="headerlink" href="#end-to-end-tests" title="Permanent link">#</a></h2>
<p>End to End tests install your release unit (image + yaml) into a cluster, then runs verification against the cluster and the application.</p>
<p>The most common use-case of this type of test is <a href="https://en.wikipedia.org/wiki/Smoke_testing_(software)">smoke testing</a>, but we <strong>can</strong> also test a multitude of integration scenarios using this approach.</p>
<h3 id="example_2">Example<a class="headerlink" href="#example_2" title="Permanent link">#</a></h3>
<p>We will do e2e testing to get a <strong>basic verification</strong> of our:</p>
<ul>
<li><strong>packaging system</strong> (does the image work and install with the yaml pipeline?)</li>
<li><strong>controller happy path</strong> (does it reconcile on cluster mutation?)</li>
</ul>
<p>This thus focuses entirely on the extreme <strong>high-level details</strong>, leaving lower-level specifics to integration tests, mocked unit tests, or even linting tools (for yaml verification).</p>
<p>As a result, we do not require any additional Rust code, as here we will treat the controller as a black box, and do all verification with <code>kubectl</code>.</p>
<div class="admonition note">
<p class="admonition-title">E2E Container Building</p>
<p>An e2e test will require access to the built container image, so spending time on CI caching can be helpful.</p>
</div>
<!-- TODO: link to container doc-->

<p>An example setup for GitHub Actions:</p>
<div class="highlight"><pre><span></span><code><span class="w">  </span><span class="nt">e2e</span><span class="p">:</span>
<span class="w">    </span><span class="nt">runs-on</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">ubuntu-latest</span>
<span class="w">    </span><span class="nt">needs</span><span class="p">:</span><span class="w"> </span><span class="p p-Indicator">[</span><span class="nv">docker</span><span class="p p-Indicator">]</span>
<span class="w">    </span><span class="nt">steps</span><span class="p">:</span>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">uses</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">actions/checkout@v2</span>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">uses</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">nolar/setup-k3d-k3s@v1</span>
<span class="w">        </span><span class="nt">with</span><span class="p">:</span>
<span class="w">          </span><span class="nt">version</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">v1.25</span>
<span class="w">          </span><span class="nt">k3d-name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">kube</span>
<span class="w">          </span><span class="nt">k3d-args</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;--no-lb</span><span class="nv"> </span><span class="s">--no-rollback</span><span class="nv"> </span><span class="s">--k3s-arg</span><span class="nv"> </span><span class="s">--disable=traefik,servicelb,metrics-server@server:*&quot;</span>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Set up Docker Buildx</span>
<span class="w">        </span><span class="nt">uses</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">docker/setup-buildx-action@v2</span>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Download docker image artifact from docker job</span>
<span class="w">        </span><span class="nt">uses</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">actions/download-artifact@v3</span>
<span class="w">        </span><span class="nt">with</span><span class="p">:</span>
<span class="w">          </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">controller-image</span>
<span class="w">          </span><span class="nt">path</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">/tmp</span>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Load docker image from tarball</span>
<span class="w">        </span><span class="nt">run</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">docker load --input /tmp/image.tar</span>
<span class="w">      </span><span class="c1"># install crd + controller (via chart)</span>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">run</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">kubectl apply -f yaml/crd.yaml</span>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">run</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">helm template charts/doc-controller | kubectl apply -f -</span>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">run</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">kubectl wait --for=condition=available deploy/doc-controller --timeout=20s</span>
<span class="w">      </span><span class="c1"># add a test intance</span>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">run</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">kubectl apply -f yaml/instance-samuel.yaml</span>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">run</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">kubectl wait --for=condition=somecondition doc/samuel --timeout 2</span>
<span class="w">      </span><span class="c1"># verify basic happy path outcomes have happened</span>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">run</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">kubectl get event --field-selector &quot;involvedObject.kind=Document,involvedObject.name=samuel&quot; | grep &quot;HideRequested&quot;</span>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">run</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">kubectl get doc -oyaml | grep -A1 finalizers | grep documents.kube.rs</span>
</code></pre></div>
<p>Here we are loading a built container via <a href="https://docs.docker.com/engine/reference/commandline/buildx_build/">docker buildx</a> from a different test job (named <code>docker</code> here) stashed as a <a href="https://github.com/actions/upload-artifact">build artifact</a>. Building images will be covered elsewhere, but you can see the <a href="https://github.com/kube-rs/controller-rs/blob/main/.github/workflows/ci.yml">CI configuration for controller-rs</a> as a reference.</p>
<p>Once the image and the cluster (same <a href="https://k3d.io/">k3d</a> setup) is available, we can install the <abbr title="Custom Resource Definition">CRD</abbr>, a test document, and the deployment yaml using whatever yaml pipeline we <del>want</del>/<em>have</em> to deal with (here <a href="https://helm.sh/">helm</a>).</p>
<p>After installations and resources are ready (checked by <a href="https://kubernetes.io/docs/reference/generated/kubectl/kubectl-commands#wait">kubectl wait</a> or a simpler <code>sleep</code> if you do not have enough conditions), we can verify that <strong>basic changes have occurred</strong> in the cluster.</p>
<!-- TODO: link to docker / container / packaging doc here -->

<div class="admonition note">
<p class="admonition-title"><abbr title="Custom Resource Definition">CRD</abbr> installation</p>
<p>We separated the <abbr title="Custom Resource Definition">CRD</abbr> installation and the deployment installation because <abbr title="Custom Resource Definition">CRD</abbr> write access is generally a much stronger security requirement that is often controlled separately in a corporate environment.</p>
</div>
<!-- TODO: move crd split note to packaging doc -->

<h3 id="benefits_3">Benefits<a class="headerlink" href="#benefits_3" title="Permanent link">#</a></h3>
<p>These tests are <strong>useful</strong> because they cover the interface between the yaml and the application along with most <strong>unknown-unknowns</strong>. E.g. do you read a new evar in the app now? Did you typo something in <abbr title="Role-based access control">RBAC</abbr>, or provide insufficient access?</p>
<p>By having <strong>a single e2e test</strong> we can avoid most of those awkward post-release hot-fixes.</p>
<div class="admonition note">
<p class="admonition-title">Different approaches</p>
<p>It is possible to detect <strong>some</strong> of these failure modes in other ways. Schema testing via <a href="https://github.com/yannh/kubeconform">kubeconform</a>, or client-side admission policy verification via <a href="https://www.conftest.dev/">conftest</a> for <a href="https://www.openpolicyagent.org/">OPA</a>, or <a href="https://github.com/kubewarden/kwctl">kwctl</a> for <a href="https://www.kubewarden.io/">kubewarden</a>, or <a href="https://github.com/FairwindsOps/polaris#cli">polaris CLI</a> for <a href="https://www.fairwinds.com/polaris">polaris</a> to name a few. You should consider these, but note that they are not foolproof. Policy tests generally verify security constraints, and schema tests are limited by schema completeness and openapi.</p>
</div>
<h3 id="downsides_3">Downsides<a class="headerlink" href="#downsides_3" title="Permanent link">#</a></h3>
<p>In addition to requiring slightly more complicated CI, the main <strong>new downside</strong> of using e2e tests over integration tests is <strong>error handling complexity</strong>; all possible failures modes can occur - often with bad error messages. On top of this, all the previous integration test downsides still apply.</p>
<p>As a result, we only want a <strong>small number of e2e tests</strong> as the signal to noise ratio is going to be low, and errors may not be obvious from failures.</p>
<h2 id="summary">Summary<a class="headerlink" href="#summary" title="Permanent link">#</a></h2>
<p>Each test category comes with its own unique set of benefits and challenges:</p>
<table>
<thead>
<tr>
<th>Test Type</th>
<th>Isolation</th>
<th>Maintenance Cost</th>
<th>Main Test Case</th>
</tr>
</thead>
<tbody>
<tr>
<td>End-to-End</td>
<td><span class="twemoji"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12 19 6.41Z"/></svg></span> No</td>
<td>Reliability + Isolation + Debug</td>
<td>Real IO + Full Smoke</td>
</tr>
<tr>
<td>Integration</td>
<td><span class="twemoji"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12 19 6.41Z"/></svg></span> No</td>
<td>Reliability + Isolation</td>
<td>Real IO + Smoke</td>
</tr>
<tr>
<td>Unit w/mocks</td>
<td><span class="twemoji"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M21 7 9 19l-5.5-5.5 1.41-1.41L9 16.17 19.59 5.59 21 7Z"/></svg></span> Yes</td>
<td>Complexity + Readability</td>
<td>Substitute IO</td>
</tr>
<tr>
<td>Unit</td>
<td><span class="twemoji"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M21 7 9 19l-5.5-5.5 1.41-1.41L9 16.17 19.59 5.59 21 7Z"/></svg></span> Yes</td>
<td>Unrealistic Scenarios</td>
<td>Non-IO</td>
</tr>
</tbody>
</table>
<p>The high cost of end-to-end and integration tests is almost entirely due to reliability issues with clusters on CI that ends up being a constant cost. The lack of test isolation in these real environments also make them more attractive as a form of <strong>sanity verification</strong>/smoke.</p>
<p>Focusing on the <strong>lower end</strong> of the test pyramid (by separating the IO code from your business logic, or by mocking liberally), and proving a few specialized tests at the top end, is likely to to have the biggest <strong>benefit-to-pain ratio</strong>. As an exercise in redundancy, <a href="https://github.com/kube-rs/controller-rs/blob/main/.github/workflows/ci.yml">controller-rs does everything</a>, and can be inspected as <strong>a</strong> reference.</p>





                
              </article>
            </div>
          
          
        </div>
        
      </main>
      
        <footer class="md-footer">
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-copyright">
  
  
</div>
      
        <div class="md-social">
  
    
    
      
      
    
    <a href="https://kube.rs" target="_blank" rel="noopener" title="kube.rs" class="md-social__link">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 384 512"><!--! Font Awesome Free 6.2.1 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2022 Fonticons, Inc.--><path d="M336 0H48C21.49 0 0 21.49 0 48v431.9c0 24.7 26.79 40.08 48.12 27.64L192 423.6l143.9 83.93c21.3 11.57 48.1-2.93 48.1-27.63V48c0-26.51-21.5-48-48-48zm0 452-144-84-144 84V54c0-3.37 2.63-6 5.1-6h276c4.3 0 6.9 2.63 6.9 6v398z"/></svg>
    </a>
  
    
    
      
      
    
    <a href="https://github.com/kube-rs/website" target="_blank" rel="noopener" title="github.com" class="md-social__link">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 496 512"><!--! Font Awesome Free 6.2.1 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2022 Fonticons, Inc.--><path d="M165.9 397.4c0 2-2.3 3.6-5.2 3.6-3.3.3-5.6-1.3-5.6-3.6 0-2 2.3-3.6 5.2-3.6 3-.3 5.6 1.3 5.6 3.6zm-31.1-4.5c-.7 2 1.3 4.3 4.3 4.9 2.6 1 5.6 0 6.2-2s-1.3-4.3-4.3-5.2c-2.6-.7-5.5.3-6.2 2.3zm44.2-1.7c-2.9.7-4.9 2.6-4.6 4.9.3 2 2.9 3.3 5.9 2.6 2.9-.7 4.9-2.6 4.6-4.6-.3-1.9-3-3.2-5.9-2.9zM244.8 8C106.1 8 0 113.3 0 252c0 110.9 69.8 205.8 169.5 239.2 12.8 2.3 17.3-5.6 17.3-12.1 0-6.2-.3-40.4-.3-61.4 0 0-70 15-84.7-29.8 0 0-11.4-29.1-27.8-36.6 0 0-22.9-15.7 1.6-15.4 0 0 24.9 2 38.6 25.8 21.9 38.6 58.6 27.5 72.9 20.9 2.3-16 8.8-27.1 16-33.7-55.9-6.2-112.3-14.3-112.3-110.5 0-27.5 7.6-41.3 23.6-58.9-2.6-6.5-11.1-33.3 2.6-67.9 20.9-6.5 69 27 69 27 20-5.6 41.5-8.5 62.8-8.5s42.8 2.9 62.8 8.5c0 0 48.1-33.6 69-27 13.7 34.7 5.2 61.4 2.6 67.9 16 17.7 25.8 31.5 25.8 58.9 0 96.5-58.9 104.2-114.8 110.5 9.2 7.9 17 22.9 17 46.4 0 33.7-.3 75.4-.3 83.6 0 6.5 4.6 14.4 17.3 12.1C428.2 457.8 496 362.9 496 252 496 113.3 383.5 8 244.8 8zM97.2 352.9c-1.3 1-1 3.3.7 5.2 1.6 1.6 3.9 2.3 5.2 1 1.3-1 1-3.3-.7-5.2-1.6-1.6-3.9-2.3-5.2-1zm-10.8-8.1c-.7 1.3.3 2.9 2.3 3.9 1.6 1 3.6.7 4.3-.7.7-1.3-.3-2.9-2.3-3.9-2-.6-3.6-.3-4.3.7zm32.4 35.6c-1.6 1.3-1 4.3 1.3 6.2 2.3 2.3 5.2 2.6 6.5 1 1.3-1.3.7-4.3-1.3-6.2-2.2-2.3-5.2-2.6-6.5-1zm-11.4-14.7c-1.6 1-1.6 3.6 0 5.9 1.6 2.3 4.3 3.3 5.6 2.3 1.6-1.3 1.6-3.9 0-6.2-1.4-2.3-4-3.3-5.6-2z"/></svg>
    </a>
  
    
    
      
      
    
    <a href="https://twitter.com/kube_rs" target="_blank" rel="noopener" title="twitter.com" class="md-social__link">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><!--! Font Awesome Free 6.2.1 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2022 Fonticons, Inc.--><path d="M459.37 151.716c.325 4.548.325 9.097.325 13.645 0 138.72-105.583 298.558-298.558 298.558-59.452 0-114.68-17.219-161.137-47.106 8.447.974 16.568 1.299 25.34 1.299 49.055 0 94.213-16.568 130.274-44.832-46.132-.975-84.792-31.188-98.112-72.772 6.498.974 12.995 1.624 19.818 1.624 9.421 0 18.843-1.3 27.614-3.573-48.081-9.747-84.143-51.98-84.143-102.985v-1.299c13.969 7.797 30.214 12.67 47.431 13.319-28.264-18.843-46.781-51.005-46.781-87.391 0-19.492 5.197-37.36 14.294-52.954 51.655 63.675 129.3 105.258 216.365 109.807-1.624-7.797-2.599-15.918-2.599-24.04 0-57.828 46.782-104.934 104.934-104.934 30.213 0 57.502 12.67 76.67 33.137 23.715-4.548 46.456-13.32 66.599-25.34-7.798 24.366-24.366 44.833-46.132 57.827 21.117-2.273 41.584-8.122 60.426-16.243-14.292 20.791-32.161 39.308-52.628 54.253z"/></svg>
    </a>
  
</div>
      
    </div>
  </div>
</footer>
      
    </div>
    <div class="md-dialog" data-md-component="dialog">
      <div class="md-dialog__inner md-typeset"></div>
    </div>
    
    <script id="__config" type="application/json">{"base": "../..", "features": ["navigation.tabs", "navigation.sections", "navigation.instant", "navigation.tracking"], "search": "../../assets/javascripts/workers/search.12658920.min.js", "translations": {"clipboard.copied": "Copied to clipboard", "clipboard.copy": "Copy to clipboard", "search.result.more.one": "1 more on this page", "search.result.more.other": "# more on this page", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents", "search.result.placeholder": "Type to start searching", "search.result.term.missing": "Missing", "select.version": "Select version"}}</script>
    
    
      <script src="../../assets/javascripts/bundle.5cf534bf.min.js"></script>
      
    
  </body>
</html>